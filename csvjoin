#!/usr/bin/env python

import argparse
from cStringIO import StringIO
import sys

from csvkit import init_common_parser, extract_csv_reader_kwargs
from csvkit import join
from csvkit import table 

def parse_join_column_names(join_string):
    """
    Parse a list of join columns.
    """
    return map(str.strip, join_string.split(','))

def get_tables(args):
    """
    Create Table objects for all input files.
    """
    tabs = []
    reader_kwargs = extract_csv_reader_kwargs(args)

    print args.files

    for f in args.files:
        tabs.append(table.Table.from_csv(f, **reader_kwargs))

    return tabs

def main(args):
    """
    Join 2 or more CSVs on a common column.
    """
    if len(args.files) < 2:
        sys.exit('You must specify at least two files to join.')

    if args.join:
        join_column_names = parse_join_column_names(args.join)

        if len(join_column_names) == 1:
            join_column_names = join_column_names * len(args.files)

        if len(join_column_names) != len(args.files):
            sys.exit('The number of join column names must match the number of files, or be a single column name for all files.')

    if (args.left_join or args.right_join or args.outer_join) and not args.join:
        sys.exit('You must provide join column names when performing a left outer, right outer, full outer join.')

    if args.left_join and args.right_join:
         sys.exit('It is not valid to specify both a left and a right join.')

    jointab = table.Table()
    tabs = get_tables(args)

    if args.left_join:
        # Left outer join
        jointab.extend(tabs[0])

        for i, t in enumerate(tabs[1:]):
            join.left_outer_join(jointab, join_column_names[0], t, join_column_names[i + 1])
    elif args.right_join:
        # Right outer join
        jointab.extend(tabs[-1])

        for i, t in enumerate(tabs[:-1].reverse()):
            join.right_outer_join(t, join_column_names[-(i + 2)], jointab, join_column_names[-1])
    elif args.outer_join:
        # Full outer join
        jointab.extend(tabs[0])

        for t in tabs[1:]:
            join.full_outer_join(jointab, join_column_names[0], t, join_column_names[i + 1])
    else:
        if args.join:
            # Inner join
            jointab.extend(tabs[0])

            for t in tabs[1:]:
                join.inner_join(jointab, join_column_names[0], t, join_column_names[i + 1])
        else:
            # Sequential join
            for t in tabs:
                jointab.extend(t)

    o = StringIO()
    output = jointab.to_csv(o)
    output = o.getvalue()
    o.close()

    print output
    
if __name__ == '__main__':
    """
    Parse command line arguments.
    """
    parser = init_common_parser(description='Join a CSV file on a specified column or columns.', epilog="Note that the join operation requires reading all files into memory. Don't try this on very large files.", omitflags='f')

    parser.add_argument('files', metavar="FILES", nargs='+', type=argparse.FileType('r'),
                        help='The CSV files to operate on. If only one is specified, it will be copied to STDOUT.')
    parser.add_argument('-j', '--join', dest='join',
                        help='The column name(s) on which to join. Should be either one name or a comma-separated list with one name for each file, in the same order the files were specified. May also be left unspecified, in which case the two files will be joined sequentially without performing any matching.')
    parser.add_argument('--outer', dest='outer_join', action='store_true',
                        help='Perform a full outer join, rather than the default inner join.')
    parser.add_argument('--left', dest='left_join', action='store_true',
                        help='Perform a left outer join, rather than the default inner join. If more than two files are provided this will be executed as a sequence of left outer joins, starting at the left.')
    parser.add_argument('--right', dest='right_join', action='store_true',
                        help='Perform a right outer join, rather than the default inner join. If more than two files are provided this will be executed as a sequence of right outer joins, starting at the right.')

    main(parser.parse_args())
